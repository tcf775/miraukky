<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Éü„ÉÉ„Ç≠„Éº„É©„ÉÉ„Ç≠„Éº„Ç¶„Ç£„Çπ„Ç≠„Éº„Ç≤„Éº„É†</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fireworks-js@2.10.8/dist/index.umd.js"></script>
    <script src="face-detection.js"></script>
    <link rel="stylesheet" href="css/support-animations.css">
    <script src="js/support-messages.js"></script>
    <script src="js/emotion-support.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            overflow-x: hidden;
        }
        
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.45);
            padding: 20px;
            border-radius: 30px;
            max-width: 1200px;
            width: 95%;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 10000;
        }
        
        
        #video { 
            width: 100%;
            max-width: 800px;        /* ÊúÄÂ§ßÂπÖ„ÇíÊã°Â§ß */
            height: auto;
            aspect-ratio: 4/3;
            border-radius: 20px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform: scaleX(-1);
            border: 5px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
            display: block;
            margin: 0 auto;
            position: relative;
        }
        
        #faceCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            max-width: 800px;        /* ÊúÄÂ§ßÂπÖ„ÇíÊã°Â§ß */
            height: auto;
            aspect-ratio: 4/3;
            transform: scaleX(-1);
            pointer-events: none;
            margin: 0 auto;
        }
        
        #video:hover {
            transform: scaleX(-1) scale(1.02);
            box-shadow: 0 15px 50px rgba(255, 215, 0, 0.5);
        }
        
        .instruction {
            font-size: clamp(0.9em, 3vw, 1.3em);
            margin: 15px 0;
            color: #6bcf7f;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-weight: 700;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        button {
            font-size: clamp(1em, 4vw, 1.8em);
            padding: clamp(15px, 3vw, 20px) clamp(30px, 8vw, 50px);
            margin: 10px;
            border: none;
            border-radius: 60px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(245, 87, 108, 0.4);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
        }
        
        button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        button:hover { 
            transform: scale(1.1) rotate(2deg);
            box-shadow: 0 12px 35px rgba(245, 87, 108, 0.6);
        }
        
        button:active {
            transform: scale(0.95);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }
        
        .result {
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin: 20px 0;
            font-weight: 900;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            animation: resultAppear 0.8s ease-out;
        }
        
        @keyframes resultAppear {
            0% { transform: scale(0) rotate(360deg); opacity: 0; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        
        .photos {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .photo-item {
            text-align: center;
            animation: photoSlideIn 0.6s ease-out;
            transition: transform 0.3s;
        }
        
        .photo-item:hover {
            transform: translateY(-10px) rotate(2deg);
        }
        
        @keyframes photoSlideIn {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .photo-item img {
            width: clamp(150px, 30vw, 200px);
            height: clamp(112px, 22.5vw, 150px);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            transform: scaleX(-1);
            border: 3px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s;
        }
        
        .photo-item img:hover {
            box-shadow: 0 12px 30px rgba(255, 215, 0, 0.6);
        }
        
        .photo-item .label {
            margin-top: 10px;
            font-size: clamp(0.9em, 2.5vw, 1.1em);
            font-weight: 700;
        }
        
        .emotion-details {
            font-size: clamp(0.7em, 2vw, 0.9em);
            margin-top: 5px;
            text-align: left;
            background: rgba(0,0,0,0.4);
            padding: 10px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .emotion-bar {
            display: flex;
            align-items: center;
            margin: 3px 0;
        }
        
        .emotion-bar .name {
            width: 80px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .emotion-bar .bar {
            flex: 1;
            height: 18px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 0 5px;
        }
        
        .emotion-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 50%, #ffd93d 100%);
            transition: width 0.5s ease-out;
            animation: barGlow 2s ease-in-out infinite;
        }
        
        @keyframes barGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
        }
        
        .emotion-bar .value {
            width: 50px;
            text-align: right;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        #feverCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            display: none;
        }
        
        #fireworksCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        /* È°îÊ§úÂá∫„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ */
        .feedback-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .detection-indicator {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
        }

        .detection-indicator.detected {
            background: rgba(0, 128, 0, 0.8);
        }

        .detection-indicator.not-detected {
            background: rgba(255, 0, 0, 0.8);
        }

        .confidence-bar {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            margin-top: 5px;
        }

        .confidence-bar::after {
            content: '';
            display: block;
            height: 100%;
            background: #4CAF50;
            border-radius: 2px;
            width: var(--confidence, 0%);
            transition: width 0.3s ease;
        }

        .detection-message {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
            padding: 10px;
            border-radius: 8px;
            display: none;
            font-weight: 600;
        }

        .detection-message.show {
            display: block;
        }

        .detection-message.error {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        .fever-text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000;
            animation: feverPulse 0.5s ease-in-out;
            z-index: 10000;
            pointer-events: none;
        }
        
        .countdown-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 15em;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 40px #ff0000, 0 0 80px #ff0000, 5px 5px 20px rgba(0,0,0,0.8);
            animation: countdownPulse 0.5s ease-out;
            z-index: 10001;
            pointer-events: none;
        }
        
        .phrase-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em;
            font-weight: 900;
            color: #ff6b6b;
            text-shadow: 0 0 40px #ff6b6b, 0 0 80px #ff6b6b, 10px 10px 30px rgba(0,0,0,0.9);
            animation: phraseBoom 0.8s ease-out;
            z-index: 10001;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .shutter-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10em;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 40px #ffd700, 0 0 80px #ffd700, 10px 10px 30px rgba(0,0,0,0.9);
            animation: shutterBoom 0.8s ease-out;
            z-index: 10001;
            pointer-events: none;
            white-space: nowrap;
        }
        
        .score-overlay {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: 700;
            color: #4CAF50;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 15px;
            text-shadow: 0 0 10px #4CAF50;
            animation: scoreSlideIn 0.5s ease-out;
            z-index: 10001;
            pointer-events: none;
        }
        
        @keyframes phraseBoom {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(-10deg); 
                opacity: 0; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3) rotate(5deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        @keyframes nicoSlide {
            0% { 
                right: -100%;
            }
            100% { 
                right: 100%;
            }
        }
        
        @keyframes shutterBoom {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(-10deg); 
                opacity: 0; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.3) rotate(5deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        @keyframes phraseSlideIn {
            0% { 
                transform: translate(-50%, -50%) scale(0) rotate(-180deg); 
                opacity: 0; 
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.2) rotate(0deg); 
                opacity: 1; 
            }
            100% { 
                transform: translate(-50%, -50%) scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }
        
        @keyframes shutterFlash {
            0% { 
                transform: translate(-50%, -50%) scale(0); 
                opacity: 0; 
                background: rgba(255, 255, 255, 0.9);
            }
            30% { 
                transform: translate(-50%, -50%) scale(1.3); 
                opacity: 1; 
                background: rgba(255, 255, 255, 0.5);
            }
            100% { 
                transform: translate(-50%, -50%) scale(1); 
                opacity: 1; 
                background: transparent;
            }
        }
        
        @keyframes scoreSlideIn {
            0% { 
                transform: translate(-50%, -50%) translateY(-30px); 
                opacity: 0; 
                scale: 0.8;
            }
            100% { 
                transform: translate(-50%, -50%) translateY(0); 
                opacity: 1; 
                scale: 1;
            }
        }
        
        @keyframes countdownPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes feverPulse {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .ball-counter {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: #ffd700;
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: 900;
            z-index: 9999;
            display: none;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
            text-shadow: 0 0 10px #ffd700;
            animation: counterPulse 1s ease-in-out infinite;
        }
        
        @keyframes counterPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @media (max-width: 768px) {
            body {
                align-items: center;
                padding: 10px 0;
            }
            
            .container {
                padding: 10px;
                width: 98%;
                border-radius: 15px;
                margin: 10px auto;
            }
            
            #video {
                max-width: 100%;
                border-radius: 10px;
                border-width: 3px;
            }
            
            #faceCanvas {
                max-width: 100%;
            }
            
            .instruction {
                font-size: 1em;
                margin: 10px 0;
            }
            
            button {
                font-size: 1.2em;
                padding: 12px 25px;
                margin: 8px;
                letter-spacing: 1px;
            }
            
            .result {
                font-size: 1.5em;
                margin: 15px 0;
            }
            
            .photos {
                gap: 10px;
                margin: 15px 0;
            }
            
            .photo-item img {
                width: 100%;
                max-width: 280px;
                height: auto;
            }
            
            .photo-item .label {
                font-size: 0.95em;
            }
            
            .emotion-details {
                font-size: 0.75em;
                padding: 8px;
            }
            
            .emotion-bar .name {
                width: 60px;
                font-size: 0.75em;
            }
            
            .emotion-bar .bar {
                height: 14px;
            }
            
            .emotion-bar .value {
                width: 40px;
                font-size: 0.75em;
            }
            
            .countdown-overlay {
                font-size: 8em;
            }
            
            .phrase-overlay {
                font-size: 4em;
                white-space: normal;
                text-align: center;
                padding: 0 20px;
            }
            
            .shutter-overlay {
                font-size: 4em;
            }
            
            .score-overlay {
                font-size: 1.3em;
                padding: 8px 15px;
                top: 15%;
            }
            
            .fever-text {
                font-size: 4em;
            }
            
            .feedback-container {
                top: 10px;
                right: 10px;
                font-size: 0.85em;
            }
            
            .ball-counter {
                top: 10px;
                left: 10px;
                padding: 10px 15px;
                font-size: 1.3em;
            }
            
            .detection-indicator {
                padding: 8px;
            }
            
            .confidence-bar {
                width: 80px;
            }
            
            .photo-item:hover {
                transform: none;
            }
            
            button:hover {
                transform: scale(1.05);
            }
            
            #video:hover {
                transform: scaleX(-1);
            }
        }
    </style>
</head>
<body>
    <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 99999;">
        <div style="font-size: 3em; font-weight: 900; color: #fff; margin-bottom: 30px; text-shadow: 0 0 20px #f093fb;">üéÆ Loading...</div>
        <div style="width: 60%; max-width: 500px; height: 30px; background: rgba(255,255,255,0.2); border-radius: 15px; overflow: hidden; margin-bottom: 20px;">
            <div id="loadingBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #f093fb 0%, #f5576c 50%, #ffd93d 100%); transition: width 0.3s; box-shadow: 0 0 20px rgba(240, 147, 251, 0.8);"></div>
        </div>
        <div id="loadingText" style="font-size: 1.2em; color: #6bcf7f; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">ÂàùÊúüÂåñ‰∏≠...</div>
    </div>
    
    <canvas id="feverCanvas"></canvas>
    <div id="fireworksCanvas"></div>
    <div class="stars" id="stars"></div>
    <div id="ballCounter" class="ball-counter">üòä √ó 0</div>
    
    <div class="container" style="display: none;">
        <div class="instruction" id="instruction">üì∏ „É¢„Éá„É´Ë™≠„ÅøËæº„Åø‰∏≠...</div>
        <div style="position: relative; display: inline-block;">
            <video id="video" autoplay></video>
            <canvas id="faceCanvas"></canvas>
            <div id="supportContainer" class="support-container"></div>
        </div>
        <div style="margin: 10px 0; font-size: 0.9em; color: #ffeb3b; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
            üîä Èü≥„ÅåÂá∫„Åæ„Åô„ÅÆ„Åß„ÅîÊ≥®ÊÑè„Åè„Å†„Åï„ÅÑ
        </div>
        
        <!-- È°îÊ§úÂá∫„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØÔºàÈùûË°®Á§∫Ôºâ -->
        <div id="face-detection-feedback" class="feedback-container" style="display: none;">
            <div id="detection-indicator" class="detection-indicator">
                <span id="detection-status">È°îÊ§úÂá∫Ê∫ñÂÇô‰∏≠...</span>
                <div id="detection-confidence" class="confidence-bar"></div>
            </div>
            <div id="detection-message" class="detection-message"></div>
        </div>
        
        <div class="photos" id="photos"></div>
        <div class="result" id="result"></div>
        <button id="startBtn" onclick="startGame()" disabled>üöÄ „Çπ„Çø„Éº„ÉàÔºÅ üöÄ</button>
        <button id="retryBtn" onclick="retry()" style="display:none;">üîÑ „ÇÇ„ÅÜ‰∏ÄÂõûÔºÅ üîÑ</button>
        <div style="position: fixed; bottom: 10px; right: 10px; font-size: 0.7em; color: rgba(255,255,255,0.5); text-align: right;">
            Voiceger: Zundamon
        </div>
    </div>

    <script>
        // „Ç≠„É©„Ç≠„É©Êòü„ÇíÁîüÊàê
        const starsContainer = document.getElementById('stars');
        for (let i = 0; i < 100; i++) {
            const star = document.createElement('div');
            star.className = 'star';
            star.style.left = Math.random() * 100 + '%';
            star.style.top = Math.random() * 100 + '%';
            star.style.animationDelay = Math.random() * 3 + 's';
            starsContainer.appendChild(star);
        }
        
        const video = document.getElementById('video');
        const faceCanvas = document.getElementById('faceCanvas');
        const resultEl = document.getElementById('result');
        const photosEl = document.getElementById('photos');
        const startBtn = document.getElementById('startBtn');
        const retryBtn = document.getElementById('retryBtn');
        const instructionEl = document.getElementById('instruction');
        let faceDetectionInterval = null;
        
        const phrases = ['„Éü„ÉÉ„Ç≠„ÉºÔºÅ', '„É©„ÉÉ„Ç≠„ÉºÔºÅ', '„Ç¶„Ç£„Çπ„Ç≠„ÉºÔºÅ'];
        let currentRound = 0;
        let scores = [];
        let photos = [];
        let modelsLoaded = false;
        let feverCount = 0;
        let engine, world, canvas, feverBalls = [];
        let fireworksInstance = null;

        const emotionEmoji = {
            'happy': 'üòä',
            'sad': 'üò¢',
            'angry': 'üò†',
            'surprised': 'üòÆ',
            'fearful': 'üò®',
            'disgusted': 'ü§¢',
            'neutral': 'üòê'
        };
        
        const emotionNames = {
            'happy': 'Âπ∏Á¶è',
            'sad': 'ÊÇ≤„Åó„Åø',
            'angry': 'ÊÄí„Çä',
            'surprised': 'È©ö„Åç',
            'fearful': 'ÊÅêÊÄñ',
            'disgusted': 'Â´åÊÇ™',
            'neutral': 'ÁÑ°Ë°®ÊÉÖ'
        };

        // Ëä±ÁÅ´„Ç®„Éï„Çß„ÇØ„ÉàÔºàÁÇπÊï∞„Å´Âøú„Åò„ÅüÊºîÂá∫Ôºâ
        function fireFireworks(score) {
            if (!score || score === 0) return;
            console.log('üéÜ Ëä±ÁÅ´Áô∫Â∞ÑÔºÅ„Çπ„Ç≥„Ç¢:', score);
            
            const container = document.getElementById('fireworksCanvas');
            if (!fireworksInstance) {
                fireworksInstance = new Fireworks.Fireworks(container, {
                    rocketsPoint: { min: 50, max: 50 },
                    hue: { min: 0, max: 360 },
                    delay: { min: 10, max: 20 },
                    speed: 4,
                    acceleration: 1.1,
                    friction: 0.95,
                    gravity: 1.5,
                    particles: score === 100 ? 200 : 120,
                    explosion: 8,
                    intensity: score === 100 ? 80 : 50,
                    autoresize: true
                });
            }
            
            const duration = score === 100 ? 4000 : 3000;
            const launchCount = Math.ceil(score / 10);
            
            fireworksInstance.start();
            
            // ÈÄ£Á∂öÁô∫Â∞ÑÔºàÂ§ßÂ∞è„ÅÆÂº∑Âº±‰ªò„ÅçÔºâ
            for (let i = 0; i < launchCount; i++) {
                setTimeout(() => {
                    // 3Áô∫„Å´1Áô∫„ÅØÂ§ß„Åç„Å™Ëä±ÁÅ´
                    const isLarge = i % 3 === 0;
                    fireworksInstance.launch(isLarge ? 5 : 3);
                }, i * 200);
            }
            
            setTimeout(() => {
                fireworksInstance.stop();
            }, duration);
        }
        
        // „Çπ„Çø„Éº„Éû„Ç§„É≥Ôºà3ÈÄ£Á∂ö„Éï„Ç£„Éº„Éê„ÉºÁî®Ôºâ
        function fireStarmine() {
            const container = document.getElementById('fireworksCanvas');
            if (!fireworksInstance) {
                fireworksInstance = new Fireworks.Fireworks(container, {
                    rocketsPoint: { min: 50, max: 50 },
                    hue: { min: 0, max: 360 },
                    delay: { min: 5, max: 15 },
                    speed: 5,
                    acceleration: 1.15,
                    friction: 0.95,
                    gravity: 1.5,
                    particles: 250,
                    explosion: 10,
                    intensity: 100,
                    autoresize: true
                });
            }
            
            fireworksInstance.start();
            
            // Â§ßÈáèÈÄ£Á∂öÁô∫Â∞ÑÔºàÂ§ß‰∏≠Â∞è„ÅÆÂº∑Âº±‰ªò„ÅçÔºâ
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    // Â§ß‰∏≠Â∞è„ÅÆÂº∑Âº±
                    const size = i % 5 === 0 ? 8 : (i % 3 === 0 ? 5 : 4);
                    fireworksInstance.launch(size);
                }, i * 80);
            }
            
            // Ëä±ÁÅ´„ÇíÊâì„Å°‰∏ä„ÅíÁ∂ö„Åë„Çã
            const launchInterval = setInterval(() => {
                const size = Math.random() < 0.2 ? 10 : Math.random() < 0.5 ? 5 : 3;
                fireworksInstance.launch(size);
            }, 300);
            
            window.tripleFeverFireworks = launchInterval;
        }
        
        // Á¥ôÂêπÈõ™„Ç®„Éï„Çß„ÇØ„Éà
        function fireConfetti() {
            const kirakira = new Audio('sounds/effect/kirakira.mp3');
            kirakira.volume = 1.0;
            kirakira.play().catch(() => {});
            
            const duration = 3000;
            const end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff6b6b', '#ffd93d', '#6bcf7f', '#4d96ff', '#f093fb']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff6b6b', '#ffd93d', '#6bcf7f', '#4d96ff', '#f093fb']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        // „Ç≠„É©„Ç≠„É©„Ç®„Éï„Çß„ÇØ„Éà
        function fireSparkles() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#ffd700', '#ffed4e', '#fff']
            });
        }
        
        // Matter.jsÂàùÊúüÂåñ
        function initPhysics() {
            canvas = document.getElementById('feverCanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            engine = Matter.Engine.create();
            world = engine.world;
            world.gravity.y = 1;
            
            // Â∫ä„Å®Â£Å„Çí‰ΩúÊàê
            const ground = Matter.Bodies.rectangle(canvas.width / 2, canvas.height + 25, canvas.width, 50, { isStatic: true });
            const leftWall = Matter.Bodies.rectangle(-25, canvas.height / 2, 50, canvas.height, { isStatic: true });
            const rightWall = Matter.Bodies.rectangle(canvas.width + 25, canvas.height / 2, 50, canvas.height, { isStatic: true });
            
            Matter.World.add(world, [ground, leftWall, rightWall]);
        }
        
        // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Åü„Éú„Éº„É´Êï∞„ÇíË®àÁÆó
        function calculateBallCount(score) {
            if (score === 0) return 0;
            if (score === 100) return 100; // 100ÁÇπ„ÅØ100ÂÄã
            return Math.floor(score); // 1-99ÁÇπ„ÅØ„Çπ„Ç≥„Ç¢„Å®Âêå„ÅòÊï∞
        }
        
        // ÁîªÈù¢ÂπÖ„Å´Âøú„Åò„Åü„Éú„Éº„É´„Çµ„Ç§„Ç∫„ÇíË®àÁÆó
        function calculateBallSize() {
            const width = window.innerWidth;
            if (width <= 768) {
                // „Çπ„Éû„Éõ: Â∞è„Åï„ÇÅ
                return { min: 15, max: 25 };
            } else {
                // PC: ÈÄöÂ∏∏„Çµ„Ç§„Ç∫
                return { min: 30, max: 50 };
            }
        }
        
        // „Éï„Ç£„Éº„Éê„Éº„Ç®„Éï„Çß„ÇØ„Éà
        function fireFever(imageData, score = 100) {
            // „Ç´„Ç¶„É≥„Çø„ÉºË°®Á§∫
            const counter = document.getElementById('ballCounter');
            counter.style.display = 'block';
            // FEVER!„ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫Ôºà100ÁÇπ„ÅÆÊôÇ„ÅÆ„ÅøÔºâ
            if (score === 100) {
                const feverText = document.createElement('div');
                feverText.className = 'fever-text';
                feverText.textContent = 'üî• FEVER! üî•';
                document.body.appendChild(feverText);
                setTimeout(() => feverText.remove(), 2000);
            }
            
            // CanvasË°®Á§∫
            canvas.style.display = 'block';
            
            // ÁîªÂÉè„Çí„É≠„Éº„Éâ
            const img = new Image();
            img.src = imageData;
            
            // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Åü„Éú„Éº„É´Êï∞„ÇíË®àÁÆó
            const ballCount = calculateBallCount(score);
            const ballSize = calculateBallSize();
            const interval = score === 100 ? 50 : 100; // 100ÁÇπ„ÅÆÂ†¥Âêà„ÅØÈ´òÈÄü„ÅßÈôç„Çâ„Åõ„Çã
            
            for (let i = 0; i < ballCount; i++) {
                setTimeout(() => {
                    const x = Math.random() * canvas.width;
                    const radius = ballSize.min + Math.random() * (ballSize.max - ballSize.min);
                    const ball = Matter.Bodies.circle(x, -50, radius, {
                        restitution: 0.6,
                        friction: 0.1
                    });
                    ball.imageElement = img;
                    Matter.World.add(world, ball);
                    feverBalls.push(ball);
                    
                    const ballSound = new Audio(`sounds/ball/${Math.floor(Math.random() * 3) + 1}.mp3`);
                    ballSound.volume = 0.5;
                    ballSound.play().catch(() => {});
                }, i * interval);
            }
            
            // Áâ©ÁêÜ„Ç®„É≥„Ç∏„É≥ÈñãÂßãÔºàÂÅúÊ≠¢„Åó„Å¶„ÅÑ„ÅüÂ†¥Âêà„ÅÆ„ÅøÂÜçÈñãÔºâ
            if (!engine.runner) {
                engine.runner = Matter.Runner.create();
                Matter.Runner.run(engine.runner, engine);
            }
            // ÊèèÁîª„É´„Éº„Éó„ÅåÂãï„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÈñãÂßã
            if (canvas.style.display === 'block') {
                renderLoop();
            }
        }
        
        // „Éú„Éº„É´„Ç´„Ç¶„É≥„Çø„ÉºÊõ¥Êñ∞
        let isCounterLocked = false;
        
        function updateBallCounter() {
            if (isCounterLocked) return;
            const counter = document.getElementById('ballCounter');
            counter.textContent = `üòä √ó ${feverBalls.length}`;
        }
        
        // „Ç´„Ç¶„É≥„Çø„Éº„Çí999„Åæ„Åß„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó„Åó„Å¶‚àû„Å´
        function animateCounterToInfinity() {
            isCounterLocked = true; // „Ç´„Ç¶„É≥„Çø„Éº„Çí„É≠„ÉÉ„ÇØ
            const counter = document.getElementById('ballCounter');
            const startCount = feverBalls.length;
            const target = 999;
            const duration = 5000; // 5Áßí„Åß999„Åæ„Åß
            const startTime = Date.now();
            
            const animate = () => {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // „Ç§„Éº„Ç∏„É≥„Ç∞Èñ¢Êï∞ÔºàÂä†ÈÄüÔºâ
                const eased = progress * progress;
                const count = Math.floor(startCount + (target - startCount) * eased);
                
                counter.textContent = `üòä √ó ${count}`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // 999„Å´Âà∞ÈÅîÂæå„ÄÅÂ∞ë„ÅóÂæÖ„Å£„Å¶‚àû„Å´
                    setTimeout(() => {
                        counter.textContent = 'üòä √ó ‚àû';
                        counter.style.fontSize = '2.5em';
                    }, 500);
                }
            };
            
            animate();
        }
        
        // ÊèèÁîª„É´„Éº„Éó
        function renderLoop() {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            updateBallCounter();
            
            feverBalls.forEach(ball => {
                if (!ball.imageElement) return;
                
                ctx.save();
                ctx.translate(ball.position.x, ball.position.y);
                ctx.rotate(ball.angle);
                
                // Á¨ëÈ°îÂÜôÁúü„ÇíÂÜÜÂΩ¢„Å´„ÇØ„É™„ÉÉ„Éó„Åó„Å¶ÊèèÁîª
                ctx.beginPath();
                ctx.arc(0, 0, ball.circleRadius, 0, Math.PI * 2);
                ctx.clip();
                
                const size = ball.circleRadius * 2;
                ctx.drawImage(ball.imageElement, -ball.circleRadius, -ball.circleRadius, size, size);
                
                ctx.restore();
                
                // ÁôΩ„ÅÑÁ∏Å„ÇíÊèèÁîª
                ctx.save();
                ctx.translate(ball.position.x, ball.position.y);
                ctx.beginPath();
                ctx.arc(0, 0, ball.circleRadius, 0, Math.PI * 2);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.restore();
            });
            
            if (canvas.style.display === 'block') {
                requestAnimationFrame(renderLoop);
            }
        }
        
        // 3ÈÄ£Á∂ö„Éï„Ç£„Éº„Éê„Éº
        function fireTripleFever() {
            const feverText = document.createElement('div');
            feverText.className = 'fever-text';
            feverText.textContent = 'üéä TRIPLE FEVER! üéä';
            feverText.style.fontSize = '8em';
            document.body.appendChild(feverText);
            setTimeout(() => feverText.remove(), 3000);
            
            // „Çπ„Çø„Éº„Éû„Ç§„É≥„Åã„Çâ„ÅÆË∂ÖÂ∑®Â§ßËä±ÁÅ´
            fireStarmine();
            
            // ÈÄ£Á∂öÊ≠ìÂ£∞„É´„Éº„ÉóÔºà10Áßí„ÅßÂÅúÊ≠¢Ôºâ
            const crowdInterval = setInterval(() => {
                const effects = ['kansei.mp3', 'kanseitohakusyu.mp3', 'kiiroihimei.mp3', 'waaaaaaa.mp3'];
                const crowd = new Audio(`sounds/effect/${effects[Math.floor(Math.random() * effects.length)]}`);
                crowd.volume = 1.0;
                crowd.play().catch(() => {});
            }, 2000);
            window.tripleFeverCrowd = crowdInterval;
            
            // 10ÁßíÂæå„Å´Ê≠ìÂ£∞„ÇíÂÅúÊ≠¢
            setTimeout(() => {
                if (window.tripleFeverCrowd) {
                    clearInterval(window.tripleFeverCrowd);
                    window.tripleFeverCrowd = null;
                }
            }, 10000);
            
            // ÁîªÈù¢„ÅÑ„Å£„Å±„ÅÑ„Å´Á¨ëÈ°î„Éú„Éº„É´„ÇíÈôç„Çâ„Åõ„Çã
            canvas.style.display = 'block';
            
            // 3Êûö„ÅÆÂÜôÁúü„Åô„Åπ„Å¶„Çí‰ΩøÁî®
            photos.forEach((photo, photoIndex) => {
                const img = new Image();
                img.src = photo.image;
                
                // 1ÂÜôÁúü„ÅÇ„Åü„Çä100ÂÄã„ÅÆ„Éú„Éº„É´ÔºàÂêàË®à300ÂÄãÔºâ
                const ballSize = calculateBallSize();
                const totalBalls = 100;
                
                for (let i = 0; i < totalBalls; i++) {
                    setTimeout(() => {
                        const x = Math.random() * canvas.width;
                        const radius = ballSize.min + Math.random() * (ballSize.max - ballSize.min);
                        const ball = Matter.Bodies.circle(x, -50 - Math.random() * 200, radius, {
                            restitution: 0.7,
                            friction: 0.05
                        });
                        ball.imageElement = img;
                        Matter.World.add(world, ball);
                        feverBalls.push(ball);
                        
                        const ballSound = new Audio(`sounds/ball/${Math.floor(Math.random() * 3) + 1}.mp3`);
                        ballSound.volume = 0.5;
                        ballSound.play().catch(() => {});
                    }, photoIndex * 2000 + i * 30); // ÂÜôÁúü„Åî„Å®„Å´ÊôÇÈñìÂ∑Æ„ÄÅÈ´òÈÄü„ÅßÈôç„Çâ„Åõ„Çã
                }
            });
            
            // Áâ©ÁêÜ„Ç®„É≥„Ç∏„É≥ÈñãÂßã
            if (!engine.runner) {
                engine.runner = Matter.Runner.create();
                Matter.Runner.run(engine.runner, engine);
            }
            if (canvas.style.display === 'block') {
                renderLoop();
            }
        }

        // È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let faceDetectionController = null;

        async function loadModels() {
            if (modelsLoaded) return;
        }

        // È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñÔºàÁ∞°Á¥†ÂåñÔºâ
        async function initializeFaceDetectionValidation() {
            try {
                const { FaceDetectionController } = window.faceDetectionModule;
                
                // Á∞°Á¥†Âåñ„Åï„Çå„Åü„Ç≤„Éº„É†Âà∂Âæ°„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
                const gameCallbacks = {
                    onGameBlock: (reason) => {
                        console.log('„Ç≤„Éº„É†ÈñãÂßã„Éñ„É≠„ÉÉ„ÇØ:', reason);
                    }
                };
                
                // Áµ±Âêà„Ç≥„É≥„Éà„É≠„Éº„É©„Éº„ÇíÂàùÊúüÂåñÔºà„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Ç≥„É≥„ÉÜ„Éä„ÅØ‰∏çË¶ÅÔºâ
                faceDetectionController = new FaceDetectionController(
                    video, 
                    null, 
                    gameCallbacks
                );
                
                // ÂàùÊúüÂåñ„Å®ÈñãÂßãÔºà„Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºâ
                await faceDetectionController.initialize();
                await faceDetectionController.start();
                
                console.log('È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ê©üËÉΩÂàùÊúüÂåñÂÆå‰∫Ü');
            } catch (error) {
                console.error('È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                // „Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºà„Ç≤„Éº„É†„ÅØÂãï‰Ωú„Åô„ÇãÔºâ
                faceDetectionController = null;
            }
        }

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„Éó„É™„É≠„Éº„Éâ
        const audioCache = {};
        async function preloadAudio(onProgress) {
            const essentialFiles = [
                'sounds/bgm/bgm.mp3',
                'sounds/camera/kasya.mp3',
                'sounds/count/1.wav', 'sounds/count/2.wav', 'sounds/count/3.wav',
                'sounds/effect/horn.mp3', 'sounds/effect/kansei.mp3', 'sounds/effect/kanseitohakusyu.mp3',
                'sounds/effect/kiiroihimei.mp3', 'sounds/effect/waaaaaaa.mp3', 'sounds/effect/kirakira.mp3',
                'sounds/ball/1.mp3', 'sounds/ball/2.mp3', 'sounds/ball/3.mp3'
            ];
            
            const voiceFiles = [];
            for (let i = 1; i <= 344; i += 8) {
                voiceFiles.push(`sounds/voice/voice_${String(i).padStart(3, '0')}.wav`);
            }
            
            const allFiles = [...essentialFiles, ...voiceFiles];
            let loaded = 0;
            
            for (const file of allFiles) {
                await new Promise((resolve) => {
                    const audio = new Audio(file);
                    audio.volume = file.includes('voice') ? 0.7 : 1.0;
                    audio.addEventListener('canplaythrough', () => {
                        audioCache[file] = audio;
                        loaded++;
                        if (onProgress) onProgress(loaded, allFiles.length);
                        resolve();
                    }, { once: true });
                    audio.addEventListener('error', () => {
                        loaded++;
                        if (onProgress) onProgress(loaded, allFiles.length);
                        resolve();
                    }, { once: true });
                });
            }
        }

        // BGMÂÜçÁîü
        const bgm = new Audio('sounds/bgm/bgm.mp3');
        bgm.loop = true;
        bgm.volume = 0.3;

        // „Éï„Ç£„Éº„Éê„ÉºÂäπÊûúÈü≥ÂÜçÁîü
        function playReggaeHorn(count) {
            const effects = ['horn.mp3', 'kansei.mp3', 'kanseitohakusyu.mp3', 'kiiroihimei.mp3', 'waaaaaaa.mp3', 'kirakira.mp3'];
            const hornCount = count === 1 ? 8 : count === 2 ? 12 : 20;
            
            for (let i = 0; i < hornCount; i++) {
                setTimeout(() => {
                    const horn = new Audio('sounds/effect/horn.mp3');
                    horn.volume = 0.5;
                    horn.play().catch(() => {});
                    
                    const effect = new Audio(`sounds/effect/${effects[Math.floor(Math.random() * effects.length)]}`);
                    effect.volume = 1.0;
                    effect.play().catch(() => {});
                }, i * 80);
            }
            
            if (count === 3) {
                setTimeout(() => {
                    for (let i = 0; i < 15; i++) {
                        setTimeout(() => {
                            const horn = new Audio('sounds/effect/horn.mp3');
                            horn.volume = 0.5;
                            horn.play().catch(() => {});
                            
                            const effect = new Audio(`sounds/effect/${effects[Math.floor(Math.random() * effects.length)]}`);
                            effect.volume = 1.0;
                            effect.play().catch(() => {});
                        }, i * 80);
                    }
                }, 2000);
            }
        }

        window.addEventListener('load', async () => {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingBar = document.getElementById('loadingBar');
            const loadingText = document.getElementById('loadingText');
            const container = document.querySelector('.container');
            
            try {
                loadingText.textContent = 'üìπ „Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ‰∏≠...';
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('„Åä‰Ωø„ÅÑ„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØ„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇChrome„ÄÅFirefox„ÄÅEdge„Å™„Å©„ÅÆÊúÄÊñ∞„Éñ„É©„Ç¶„Ç∂„Çí„Åä‰Ωø„ÅÑ„Åè„Å†„Åï„ÅÑ„ÄÇ');
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    } 
                });
                video.srcObject = stream;
                await new Promise(resolve => video.onloadedmetadata = resolve);
                loadingBar.style.width = '10%';
                
                loadingText.textContent = 'üì¶ AI„É¢„Éá„É´Ë™≠„ÅøËæº„Åø‰∏≠...';
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model';
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
                await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
                modelsLoaded = true;
                await initializeFaceDetectionValidation();
                loadingBar.style.width = '30%';
                
                if (typeof EmotionSupportManager !== 'undefined') {
                    window.emotionSupportManager = new EmotionSupportManager();
                    window.emotionSupportManager.initialize();
                }
                
                loadingText.textContent = 'üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø‰∏≠...';
                await preloadAudio((loaded, total) => {
                    const progress = 30 + (loaded / total) * 70;
                    loadingBar.style.width = progress + '%';
                    loadingText.textContent = `üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø‰∏≠... (${loaded}/${total})`;
                });
                
                loadingBar.style.width = '100%';
                loadingText.textContent = '‚ú® Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºÅ';
                
                await new Promise(resolve => setTimeout(resolve, 500));
                loadingScreen.style.display = 'none';
                container.style.display = 'flex';
                instructionEl.textContent = 'üë§ „Ç´„É°„É©„Å´È°î„ÇíÊò†„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                startBtn.disabled = true;
                
                // È°îÊ§úÂá∫Áõ£Ë¶ñ„ÇíÈñãÂßã
                startFaceDetection();
            } catch (err) {
                console.error('ÂàùÊúüÂåñ„Ç®„É©„Éº:', err);
                let errorMessage = '‚ö†Ô∏è „Ç®„É©„Éº: ';
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    errorMessage += '„Ç´„É°„É©„ÅÆ‰ΩøÁî®„ÅåË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ';
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessage += '„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ';
                } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
                    errorMessage += '„Ç´„É°„É©„Åå‰ªñ„ÅÆ„Ç¢„Éó„É™„Åß‰ΩøÁî®‰∏≠„Åß„Åô„ÄÇ';
                } else if (err.name === 'SecurityError') {
                    errorMessage += 'HTTPS„Åæ„Åü„ÅØlocalhost„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
                } else {
                    errorMessage += err.message || '‰∏çÊòé„Å™„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ';
                }
                
                loadingText.innerHTML = errorMessage;
                loadingBar.style.width = '100%';
                loadingBar.style.background = 'linear-gradient(90deg, #ff6b6b 0%, #ff0000 100%)';
                await new Promise(resolve => setTimeout(resolve, 2000));
                loadingScreen.style.display = 'none';
                container.style.display = 'flex';
                instructionEl.innerHTML = errorMessage;
                startBtn.disabled = false;
            }
        });

        // È°î„ÅÆËº™ÈÉ≠Á∑ö„ÇíÊèèÁîª
        async function drawFaceBox(detection) {
            // video„ÅÆË°®Á§∫„Çµ„Ç§„Ç∫„ÇíÂèñÂæó
            const displaySize = { 
                width: video.offsetWidth, 
                height: video.offsetHeight 
            };
            faceCanvas.width = displaySize.width;
            faceCanvas.height = displaySize.height;
            
            // „Çπ„Ç±„Éº„É´ÊØîÁéá„ÇíË®àÁÆó
            const scaleX = displaySize.width / video.videoWidth;
            const scaleY = displaySize.height / video.videoHeight;
            
            const ctx = faceCanvas.getContext('2d');
            ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            
            if (detection) {
                // „É©„É≥„Éâ„Éû„Éº„ÇØ„ÇíÂèñÂæó
                const landmarks = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
                    inputSize: 416,
                    scoreThreshold: 0.3
                })).withFaceLandmarks();
                
                if (landmarks && landmarks.landmarks) {
                    const points = landmarks.landmarks.positions;
                    
                    // È°î„ÅÆËº™ÈÉ≠„ÇíÊèèÁîªÔºàÈ°î„ÅÆÂ§ñÂë®„ÅÆ„ÅøÔºâ
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 3;
                    ctx.shadowColor = '#00ff00';
                    ctx.shadowBlur = 10;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    // È°î„ÅÆËº™ÈÉ≠Ôºà0-16Áï™Ôºâ„Çí„Çπ„Ç±„Éº„É´Ë™øÊï¥„Åó„Å¶ÊèèÁîª
                    ctx.beginPath();
                    for (let i = 0; i <= 16; i++) {
                        const point = points[i];
                        const x = point.x * scaleX;
                        const y = point.y * scaleY;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.stroke();
                    
                    ctx.shadowBlur = 0;
                }
            }
        }
        
        // „É™„Ç¢„É´„Çø„Ç§„É†È°îÊ§úÂá∫
        let isGameActive = false;
        
        async function startFaceDetection() {
            if (faceDetectionInterval) return;
            
            faceDetectionInterval = setInterval(async () => {
                const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
                    inputSize: 416,
                    scoreThreshold: 0.3
                })).withFaceExpressions();
                drawFaceBox(detection);
                
                // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂà∂Âæ°
                if (startBtn.style.display !== 'none') {
                    if (detection) {
                        startBtn.disabled = false;
                        instructionEl.textContent = '‚ú® Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ„Ç´„É°„É©„Å´È°î„ÇíÊò†„Åó„Å¶„Äå„Çπ„Çø„Éº„Éà„Äç„ÇíÊäº„Åó„Å¶„Å≠ÔºÅ ‚ú®';
                    } else {
                        startBtn.disabled = true;
                        instructionEl.textContent = 'üë§ „Ç´„É°„É©„Å´È°î„ÇíÊò†„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
                    }
                }
                
                // ÊÑüÊÉÖ„Çµ„Éù„Éº„ÉàÂá¶ÁêÜÔºà„Ç≤„Éº„É†‰∏≠„ÅÆ„ÅøÔºâ
                if (isGameActive && window.emotionSupportManager) {
                    window.emotionSupportManager.processEmotion(detection);
                }
            }, 100);
        }
        
        function stopFaceDetection() {
            if (faceDetectionInterval) {
                clearInterval(faceDetectionInterval);
                faceDetectionInterval = null;
                const ctx = faceCanvas.getContext('2d');
                ctx.clearRect(0, 0, faceCanvas.width, faceCanvas.height);
            }
        }

        async function detectExpression() {
            const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
                inputSize: 416,
                scoreThreshold: 0.3
            })).withFaceExpressions();
            
            if (!detection) {
                return null;
            }

            const expressions = detection.expressions;
            const emotions = {
                happy: expressions.happy * 100,
                sad: expressions.sad * 100,
                angry: expressions.angry * 100,
                surprised: expressions.surprised * 100,
                fearful: expressions.fearful * 100,
                disgusted: expressions.disgusted * 100,
                neutral: expressions.neutral * 100
            };

            const dominant = Object.entries(emotions).reduce((a, b) => a[1] > b[1] ? a : b)[0];
            
            // „É©„É≥„Éâ„Éû„Éº„ÇØÊ§úÂá∫„ÇíÂà•ÈÄîÂÆüË°å
            let mouthOpenRatio = 0;
            let smileRatio = 0;
            try {
                const landmarkDetection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({
                    inputSize: 416,
                    scoreThreshold: 0.3
                })).withFaceLandmarks();
                
                if (landmarkDetection && landmarkDetection.landmarks) {
                    const landmarks = landmarkDetection.landmarks;
                    
                    // Âè£„ÅÆÈñã„ÅçÂÖ∑Âêà
                    const upperLip = landmarks.positions[51];
                    const lowerLip = landmarks.positions[57];
                    const mouthOpen = Math.abs(lowerLip.y - upperLip.y);
                    const faceHeight = Math.abs(landmarks.positions[8].y - landmarks.positions[27].y);
                    mouthOpenRatio = mouthOpen / faceHeight;
                    
                    // Âè£Ëßí„ÅÆ‰∏ä„Åå„ÇäÂÖ∑ÂêàÔºàÂè£Ëßí„Å®Âè£„ÅÆ‰∏ãÁ´Ø„ÇíÊØîËºÉÔºâ
                    const leftCorner = landmarks.positions[48]; // Â∑¶Âè£Ëßí
                    const rightCorner = landmarks.positions[54]; // Âè≥Âè£Ëßí
                    
                    // Âè£Ëßí„Åå‰∏ãÂîá„Çà„Çä‰∏ä„Å´„ÅÇ„Çã„Åª„Å©Á¨ëÈ°î
                    const leftLift = Math.max(0, lowerLip.y - leftCorner.y);
                    const rightLift = Math.max(0, lowerLip.y - rightCorner.y);
                    const avgLift = (leftLift + rightLift) / 2;
                    smileRatio = avgLift / faceHeight;
                }
            } catch (e) {
                console.warn('„É©„É≥„Éâ„Éû„Éº„ÇØÊ§úÂá∫„Çπ„Ç≠„ÉÉ„Éó:', e);
            }
            
            // „Çπ„Ç≥„Ç¢Ë®àÁÆó: Âπ∏Á¶èÂ∫¶60% + Âè£„ÅÆÈñã„ÅçÂÖ∑Âêà20% + Âè£Ëßí„ÅÆ‰∏ä„Åå„ÇäÂÖ∑Âêà20%
            const happyScore = emotions.happy * 0.6;
            const mouthScore = Math.min(20, mouthOpenRatio * 100);
            const smileScore = Math.min(20, smileRatio * 200);
            let score = Math.round(happyScore + mouthScore + smileScore);
            score = Math.max(0, Math.min(100, score));
            
            console.log(`Happy: ${emotions.happy.toFixed(1)}%, Mouth: ${(mouthOpenRatio * 100).toFixed(1)}%, Smile: ${(smileRatio * 100).toFixed(1)}%, Score: ${score}`);

            return { emotions, dominant, score, mouthOpenRatio, smileRatio };
        }

        async function captureAndDetect() {
            const maxRetries = 3;
            let result = null;
            
            // „É™„Éà„É©„Ç§Ê©üËÉΩÔºöÊúÄÂ§ß3Âõû„Åæ„ÅßÈ°îÊ§úÂá∫„ÇíË©¶Ë°å
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                result = await detectExpression();
                if (result) break;
                
                console.warn(`È°îÊ§úÂá∫Â§±Êïó (${attempt + 1}/${maxRetries})„ÄÅÂÜçË©¶Ë°å‰∏≠...`);
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            // Ê§úÂá∫ÁµêÊûúÂèñÂæóÂæå„ÄÅÂç≥Â∫ß„Å´ÁîªÂÉè„Ç≠„É£„Éó„ÉÅ„É£
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg');
            
            if (!result) {
                console.warn('È°î„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„ÅüÔºà3ÂõûË©¶Ë°åÂæåÔºâ');
                return { 
                    score: 0, 
                    image: imageData,
                    emotions: {},
                    dominant: 'neutral',
                    mouthOpenRatio: 0,
                    smileRatio: 0
                };
            }

            return { 
                score: result.score, 
                image: imageData,
                emotions: result.emotions,
                dominant: result.dominant,
                mouthOpenRatio: result.mouthOpenRatio,
                smileRatio: result.smileRatio
            };
        }

        async function gameLoop() {
            for (let i = 0; i < 3; i++) {
                currentRound = i;
                
                // Êéõ„ÅëÂ£∞„ÇíÂ§ß„Åç„Å™„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅßË°®Á§∫Ôºà„Éâ„É≥Ë°®Á§∫Ôºâ
                const phraseOverlay = document.createElement('div');
                phraseOverlay.className = 'phrase-overlay';
                phraseOverlay.textContent = phrases[i];
                document.body.appendChild(phraseOverlay);
                setTimeout(() => phraseOverlay.remove(), 2000); // „Éâ„É≥Ë°®Á§∫„ÅØ2Áßí
                
                fireSparkles();
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥
                for (let count = 3; count > 0; count--) {
                    // ÊúÄÂâçÈù¢„Å´Â§ß„Åç„ÅèË°®Á§∫
                    const countdownEl = document.createElement('div');
                    countdownEl.className = 'countdown-overlay';
                    countdownEl.textContent = count;
                    document.body.appendChild(countdownEl);
                    setTimeout(() => countdownEl.remove(), 500);
                    
                    const countSound = new Audio(`sounds/count/${count}.wav`);
                    countSound.volume = 1.0;
                    countSound.play().catch(() => {});
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // ÊíÆÂΩ±ÔºÅ„ÇíÂ§ß„Åç„Å™„Ç™„Éº„Éê„Éº„É¨„Ç§„ÅßË°®Á§∫
                const shutterOverlay = document.createElement('div');
                shutterOverlay.className = 'shutter-overlay';
                shutterOverlay.textContent = '„Éë„Ç∑„É£ÔºÅüì∏';
                document.body.appendChild(shutterOverlay);
                setTimeout(() => shutterOverlay.remove(), 800);
                
                const shutter = new Audio('sounds/camera/kasya.mp3');
                shutter.volume = 1.0;
                shutter.play().catch(() => {});
                
                const result = await captureAndDetect();
                
                scores.push(result.score);
                photos.push({ 
                    phrase: phrases[i], 
                    image: result.image, 
                    score: result.score,
                    dominant: result.dominant,
                    emotions: result.emotions,
                    mouthOpenRatio: result.mouthOpenRatio || 0,
                    smileRatio: result.smileRatio || 0
                });
                
                // „Çπ„Ç≥„Ç¢Ë°®Á§∫„Ç™„Éº„Éê„Éº„É¨„Ç§
                const scoreOverlay = document.createElement('div');
                scoreOverlay.className = 'score-overlay';
                scoreOverlay.textContent = `${phrases[i]} - „Çπ„Ç≥„Ç¢: ${result.score}`;
                document.body.appendChild(scoreOverlay);
                setTimeout(() => scoreOverlay.remove(), 2000);
                
                // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶„Éú„Éº„É´„Å®Ëä±ÁÅ´„ÇíËêΩ„Å®„Åô
                if (result.score === 100) {
                    feverCount++;
                    playReggaeHorn(feverCount);
                }
                fireFever(result.image, result.score);
                fireFireworks(result.score);
                await new Promise(resolve => setTimeout(resolve, result.score === 100 ? 3000 : 2000));
            }
            
            stopFaceDetection();
            showResult();
        }

        async function startGame() {
            // BGMÈñãÂßã
            bgm.play().catch(() => {});
            
            // „Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„ÇíÁ¢∫Ë™ç
            if (!video.srcObject) {
                try {
                    instructionEl.textContent = 'üìπ „Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ‰∏≠...';
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    await new Promise(resolve => video.onloadedmetadata = resolve);
                    instructionEl.textContent = '‚ú® „Ç´„É°„É©Ê∫ñÂÇôÂÆå‰∫ÜÔºÅ';
                } catch (err) {
                    alert('„Ç´„É°„É©„Å´„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Åæ„Åõ„Çì: ' + err.message);
                    instructionEl.textContent = '‚ùå „Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ„Ç®„É©„Éº';
                    return;
                }
            }
            
            if (!modelsLoaded) {
                try {
                    instructionEl.textContent = 'üì¶ „É¢„Éá„É´Ë™≠„ÅøËæº„Åø‰∏≠...';
                    await loadModels();
                } catch (error) {
                    console.error('„É¢„Éá„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
                    // „É¢„Éá„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº„Åß„ÇÇ„Ç≤„Éº„É†„ÅØÁ∂öË°å
                }
            }
            
            // È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç®„É©„Éº„Åß„ÇÇÁ∂öË°åÔºâ
            try {
                if (faceDetectionController) {
                    await faceDetectionController.validateGameStart();
                }
            } catch (error) {
                console.log('È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥:', error.message);
                // „Ç®„É©„Éº„Åß„ÇÇ„Ç≤„Éº„É†„ÇíÁ∂öË°å
            }
            
            // Áâ©ÁêÜ„Ç®„É≥„Ç∏„É≥ÂàùÊúüÂåñ
            if (!engine) {
                initPhysics();
            }
            
            // ÂâçÂõû„ÅÆ„Éú„Éº„É´„Çí„ÇØ„É™„Ç¢
            feverBalls.forEach(ball => Matter.World.remove(world, ball));
            feverBalls = [];
            canvas.style.display = 'none';
            
            // „Ç≤„Éº„É†Áä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            currentRound = 0;
            scores = [];
            photos = [];
            feverCount = 0;
            resultEl.textContent = '';
            photosEl.innerHTML = '';
            instructionEl.textContent = 'üòä Êéõ„ÅëÂ£∞„Å´Âêà„Çè„Åõ„Å¶ÊúÄÈ´ò„ÅÆÁ¨ëÈ°î„ÇíË¶ã„Åõ„Å¶„Å≠ÔºÅ üòä';
            startBtn.style.display = 'none';
            retryBtn.style.display = 'none';
            video.style.display = 'block';
            
            // „Ç≤„Éº„É†„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíË®≠ÂÆö
            if (faceDetectionController) {
                faceDetectionController.setGameActive(true);
            }
            
            // ÂøúÊè¥Ê©üËÉΩ„ÇíÈñãÂßãÔºà„Ç≤„Éº„É†‰∏≠„Éï„É©„Ç∞„ÇíONÔºâ
            isGameActive = true;
            if (window.emotionSupportManager) {
                window.emotionSupportManager.reset();
            }
            
            fireConfetti();
            gameLoop();
        }

        function showResult() {
            stopFaceDetection();
            
            // „Ç´„Ç¶„É≥„Çø„Éº„ÅØË°®Á§∫„Åó„Åü„Åæ„ÅæÔºàÁµêÊûúÁîªÈù¢„Åß„ÇÇË°®Á§∫Ôºâ
            const counter = document.getElementById('ballCounter');
            counter.style.display = 'block';
            
            // „Ç≤„Éº„É†‰∏≠„Éï„É©„Ç∞„ÇíOFF
            isGameActive = false;
            
            // „Ç≤„Éº„É†„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÇíÁÑ°ÂäπÂåñ
            if (faceDetectionController) {
                faceDetectionController.setGameActive(false);
            }
            
            // ÊÑüÊÉÖ„Çµ„Éù„Éº„Éà„ÇíÂÅúÊ≠¢
            if (window.emotionSupportManager) {
                window.emotionSupportManager.stop();
            }
            
            // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„Çí„ÇØ„É™„Ç¢
            const supportContainer = document.getElementById('supportContainer');
            if (supportContainer) {
                supportContainer.innerHTML = '';
                supportContainer.style.display = 'none';
            }
            
            video.style.display = 'none';
            faceCanvas.style.display = 'none';
            instructionEl.textContent = '';
            
            // 3ÈÄ£Á∂ö„Éï„Ç£„Éº„Éê„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            if (feverCount === 3) {
                fireTripleFever();
                // „Ç´„Ç¶„É≥„Çø„Éº„Çí999„Åæ„ÅßÈ´òÈÄü„Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó„Åó„Å¶‚àû„Å´
                animateCounterToInfinity();
            }
            
            const avg = scores.reduce((a, b) => a + b, 0) / scores.length;
            let message = avg >= 80 ? 'Excellent! üéâüéäüåü' : avg >= 60 ? 'Good! üòäüëç‚ú®' : 'Try Again! üí™üî•';
            
            if (feverCount === 3) {
                message = 'üéä TRIPLE FEVERÈÅîÊàêÔºÅ üéä<br>ÂÆåÁíß„Å™Á¨ëÈ°î„Åß„ÅôÔºÅ';
            }
            
            resultEl.innerHTML = `Âπ≥Âùá„Çπ„Ç≥„Ç¢: ${avg.toFixed(1)}<br>${message}`;
            
            if (feverCount === 3) {
                // 3ÈÄ£Á∂ö„Éï„Ç£„Éº„Éê„Éº„ÅØÂ∞ÇÁî®ÊºîÂá∫
            } else if (avg >= 80) {
                fireConfetti();
                fireFireworks(Math.round(avg));
            } else {
                fireSparkles();
            }
            
            photosEl.innerHTML = photos.map((p, index) => {
                console.log('Photo data:', p); // „Éá„Éê„ÉÉ„Ç∞Áî®
                const emotionBars = Object.entries(p.emotions)
                    .sort((a, b) => b[1] - a[1])
                    .map(([emotion, value]) => `
                        <div class="emotion-bar">
                            <div class="name">${emotionEmoji[emotion]} ${emotionNames[emotion]}</div>
                            <div class="bar"><div class="fill" style="width: ${value}%"></div></div>
                            <div class="value">${value.toFixed(1)}%</div>
                        </div>
                    `).join('');
                
                // „Éú„Éº„Éä„ÇπÂä†ÁÇπÔºàÂè£„ÅÆÈñã„ÅçÂÖ∑Âêà + Âè£Ëßí„ÅÆ‰∏ä„Åå„ÇäÂÖ∑ÂêàÔºâ
                const mouthScore = Math.min(20, p.mouthOpenRatio * 100);
                const smileScore = Math.min(20, p.smileRatio * 200);
                const secretBonus = Math.round(mouthScore + smileScore);
                const additionalMetrics = `
                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div style="margin: 5px 0;">üéÅ „Éú„Éº„Éä„ÇπÂä†ÁÇπ: +${secretBonus}ÁÇπ</div>
                    </div>
                `;
                
                return `
                    <div class="photo-item" style="animation-delay: ${index * 0.2}s">
                        <img src="${p.image}" alt="${p.phrase}">
                        <div class="label">
                            <strong>${p.phrase}</strong><br>
                            ${emotionEmoji[p.dominant]} ${emotionNames[p.dominant]} - „Çπ„Ç≥„Ç¢: ${p.score}
                        </div>
                        <div class="emotion-details">
                            ${emotionBars}
                            ${additionalMetrics}
                        </div>
                    </div>
                `;
            }).join('');
            
            retryBtn.style.display = 'inline-block';
        }

        function retry() {
            // Ëä±ÁÅ´„ÇíÂÅúÊ≠¢
            if (window.tripleFeverFireworks) {
                clearInterval(window.tripleFeverFireworks);
                window.tripleFeverFireworks = null;
                if (fireworksInstance) fireworksInstance.stop();
            }
            
            // Ê≠ìÂ£∞„ÇíÂÅúÊ≠¢
            if (window.tripleFeverCrowd) {
                clearInterval(window.tripleFeverCrowd);
                window.tripleFeverCrowd = null;
            }
            
            // „Éú„Éº„É´„Çí„ÇØ„É™„Ç¢
            feverBalls.forEach(ball => Matter.World.remove(world, ball));
            feverBalls = [];
            canvas.style.display = 'none';
            
            // „Ç´„Ç¶„É≥„Çø„ÉºÈùûË°®Á§∫„Å®„É≠„ÉÉ„ÇØËß£Èô§
            const counter = document.getElementById('ballCounter');
            counter.style.display = 'none';
            counter.style.fontSize = '2em';
            isCounterLocked = false;
            
            // „Ç≤„Éº„É†‰∏≠„Éï„É©„Ç∞„ÇíOFF
            isGameActive = false;
            
            // ÊÑüÊÉÖ„Çµ„Éù„Éº„Éà„Çí„É™„Çª„ÉÉ„Éà
            if (window.emotionSupportManager) {
                window.emotionSupportManager.reset();
            }
            
            // ÂøúÊè¥„É°„ÉÉ„Çª„Éº„Ç∏„Ç≥„É≥„ÉÜ„Éä„Çí„ÇØ„É™„Ç¢
            const supportContainer = document.getElementById('supportContainer');
            if (supportContainer) {
                supportContainer.innerHTML = '';
                supportContainer.style.display = 'none';
            }
            
            // È°îÊ§úÂá∫„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ê©üËÉΩ„Çí„É™„Çª„ÉÉ„Éà
            if (faceDetectionController) {
                faceDetectionController.setGameActive(false);
            }
            
            // UIÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„Éà
            retryBtn.style.display = 'none';
            startBtn.style.display = 'inline-block';
            startBtn.disabled = true;
            video.style.display = 'block';
            resultEl.textContent = '';
            photosEl.innerHTML = '';
            instructionEl.textContent = 'üë§ „Ç´„É°„É©„Å´È°î„ÇíÊò†„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            
            // È°îÊ§úÂá∫Áõ£Ë¶ñ„ÇíÂÜçÈñã
            startFaceDetection();
            fireSparkles();
        }
    </script>
</body>
</html>
